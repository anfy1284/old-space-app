# АРХИТЕКТУРА ПРОЕКТА MY-OLD-SPACE

## ОБЩАЯ СТРУКТУРА

```
my-old-space/
├── drive_forms/
│   └── resources/public/
│       ├── UI_classes.js          # Базовые UI компоненты
│       └── style.css              # Глобальные стили (ВАЖНО!)
├── apps/
│   ├── organizations/             # Приложение для управления организациями
│   ├── uniListForm/               # Универсальная форма выбора записей
│   └── ...
```

**ВАЖНО:** `style.css` содержит все базовые стили для UI компонентов.
Всегда проверяй его наличие перед добавлением стилей через JS!

---

## БАЗОВЫЕ КЛАССЫ (UI_classes.js)

### Form
Базовый класс для всех форм.

**Ключевые свойства:**
- `element` - DOM элемент формы
- `getContentArea()` - метод получения области контента

### DataForm extends Form
Форма с автоматическим рендерингом из JSON layout.

**Ключевые свойства:**
- `layout` - массив описаний UI элементов
- `controlsMap` - Map всех созданных контролов {name: control}
- `_dataMap` - данные для полей
- `_currentRecord` - текущая выбранная запись (для таблиц)
- `table` - ссылка на первую DynamicTable (автоматически)
- `_tables[]` - массив всех DynamicTable на форме

**Ключевые методы:**
- `renderLayout(contentArea, layout)` - рендерит все элементы
- `renderItem(item, contentArea)` - рендерит один элемент

**Автоматические связи при создании DynamicTable:**
```javascript
// В renderItem, case 'table':
const tbl = new DynamicTable(config);
this.table = tbl;                    // Первая таблица
this._tables.push(tbl);              // Все таблицы
tbl.onRowActivate = (rowIndex) => {  // Автообработчик
    this._currentRecord = getRecord(rowIndex);
};
```

### Table
Базовая таблица с рендерингом строк.

**Ключевые свойства:**
- `columns` - колонки таблицы
- `_activeRowIndex` - индекс активной строки

**Ключевые методы:**
- `activateRow(rowIndex)` - активирует строку
- `deactivateRow()` - деактивирует строку

### DynamicTable extends Table
Продвинутая таблица с подгрузкой данных, редактированием, SSE.

**Ключевые свойства:**
- `appName` - имя приложения
- `tableName` - имя таблицы БД
- `dataCache` - кэш загруженных строк {index: record}
- `firstVisibleRow` - индекс первой видимой строки (для прокрутки)
- `_activeRowIndex` - локальный индекс активной строки

**Важно:**
- `_activeRowIndex` - это ЛОКАЛЬНЫЙ индекс (0-N видимых строк)
- Глобальный индекс = `firstVisibleRow + _activeRowIndex`
- `dataCache[global]` - получение записи по глобальному индексу

**Новое свойство (добавлено нами):**
- `onRowActivate(rowIndex)` - callback при активации строки
  - Вызывается из `activateRow()` после обновления UI
  - Используется для уведомления формы о выборе

**Регистрация в глобальном реестре:**
- `window._dynamicTableSubscribers` - Map всех DynamicTable
- ⚠️ НЕ ИСПОЛЬЗОВАТЬ для поиска своей таблицы! Это для SSE.

### TextBox, MultilineTextBox, Button и др.
Стандартные UI контролы с методами:
- `Draw(container)` - отрисовка
- `setText(text)` / `getText()` - работа с текстом
- `setCaption(text)` - установка заголовка

---

## СТИЛИ И CSS (style.css)

**Расположение:** `drive_forms/resources/public/style.css`

### Ключевые классы

#### `.ui-form-content`
Content area формы - область где размещаются элементы layout.

**CSS:**
```css
.ui-form-content { 
  position: relative;
  width: 100%;
  overflow: auto;
  box-sizing: border-box;
  display: flex;              /* Flexbox для вертикального размещения */
  flex-direction: column;
}

/* Все дочерние элементы по умолчанию не растягиваются */
.ui-form-content > * {
  flex: 0 0 auto;
}
```

#### `.ui-dynamictable`
Класс для DynamicTable wrapper.

**CSS:**
```css
.ui-dynamictable {
  /* ... базовые стили ... */
  flex: 1 1 auto;              /* Таблицы растягиваются! */
  min-height: 0;               /* Для корректной работы flex + overflow */
}
```

#### `.ui-group`
Группы (fieldset) для логической группировки элементов.

**CSS:**
```css
.ui-group {
  display: flex;
  /* ... */
}

.ui-group.horizontal { flex-direction: row; }
.ui-group.vertical { flex-direction: column; }
```

### Принцип работы Flexbox Layout

**Вертикальное размещение:**
1. `.ui-form-content` - flex container (column)
2. Обычные элементы - `flex: 0 0 auto` (не растягиваются)
3. Таблицы - `flex: 1 1 auto` (занимают свободное место)

**Горизонтальное растягивание:**
- Все элементы имеют `width: 100%` (задается в JS при Draw)
- Группы с `orientation: 'horizontal'` растягивают дочерние элементы горизонтально

**visibleRows (устарело):**
Свойство `visibleRows` у Table ОТКЛЮЧЕНО в UI_classes.js (закомментировано).
Раньше устанавливало фиксированную высоту, что мешало flex-растягиванию.

---

## MYSPACE FRAMEWORK

### MySpace - глобальный объект
Управляет приложениями и их экземплярами.

**Методы:**
- `MySpace.open(appName, params)` - открыть приложение
  - Возвращает Promise с instance
  - Создает новый экземпляр или использует существующий
  - params передаются в instance.onOpen(params)

- `MySpace.close(instance)` - закрыть приложение
  - Вызывает instance.destroy()
  - Удаляет из реестра активных экземпляров

### Структура приложения

```
apps/appName/
├── config.json         # Конфигурация
├── server.js          # Серверная часть (опционально)
└── resources/public/
    └── client.js      # Клиентская часть
```

### client.js - структура

```javascript
// Регистрация приложения
MySpace.registerApp('appName', (MySpace) => {
    const APP_NAME = 'appName';
    
    // Дескриптор приложения
    const descriptor = {
        name: APP_NAME,
        allowMultipleInstances: false,  // Можно ли открыть несколько
        
        // Создание экземпляра
        createInstance: async function(openParams) {
            const instanceId = generateId();
            const instance = {
                id: instanceId,
                appName: APP_NAME,
                
                // Обработчики
                onOpen(params) { /* ... */ },
                onClose() { /* ... */ },
                destroy() { /* ... */ }
            };
            return instance;
        }
    };
    
    return descriptor;
});
```

---

## ПРИЛОЖЕНИЕ uniListForm

### Назначение
Универсальная форма выбора записи из любой таблицы.

### Параметры открытия
```javascript
MySpace.open('uniListForm', {
    dbTable: 'table_name',           // имя таблицы
    onSelectCallBack: function(record) { }  // callback при выборе
});
```

### Структура instance

**Свойства:**
- `id` - уникальный ID экземпляра
- `initialOnSelectCallBack` - callback сохраненный при создании

**Методы:**
- `onOpen(params)` - вызывается при открытии
  - Создает DataForm
  - Вызывает appForm.Draw()
  - Связь с таблицей создается автоматически (!)
  
- `onSelect(callParams)` - вызывается при нажатии кнопки выбора
  - Получает currentRecord из appForm._currentRecord
  - Вызывает callback
  - Закрывает форму

- `destroy()` - очистка при закрытии
  - appForm.destroy()
  - appForm.close()

### getCurrentRow()
Метод для получения текущей выбранной записи.

**Порядок поиска:**
1. `appForm._currentRecord` - если есть (установлено через onRowActivate)
2. `appForm._dynamicTableInstance._activeRowIndex` - из сохраненной таблицы
3. Ищет в controlsMap контролы с _activeRowIndex
4. ⚠️ Fallback на window._dynamicTableSubscribers (может найти ЧУЖУЮ таблицу!)
5. Из _dataMap

**Проблема (исправленная):**
Fallback на глобальный реестр находил чужую таблицу от другого экземпляра uniListForm.

**Решение:**
DataForm автоматически устанавливает `_currentRecord` через `onRowActivate`.

---

## ОРГАНИЗАЦИЯ recordEditor/recordSelector

### TextBox с selection button
В organizations приложении поле "Тип размещения" - это TextBox с кнопкой "...".

**Обработчик клика (UI_classes.js ~3120):**
```javascript
TextBox.onSelectionStart = async function() {
    const callback = (selectedRecord) => {
        this.setText(selectedRecord.name);  // Обновляет ЭТОТ TextBox
    };
    
    await MySpace.open('uniListForm', {
        dbTable: 'accommodation_types',
        onSelectCallBack: callback.bind(this)  // bind к ЭТОМУ TextBox
    });
};
```

**Важно:**
- Callback привязан к конкретному TextBox через bind(this)
- Каждая кнопка "..." создает свой callback
- Проблема была НЕ в callback (они правильные), а в getCurrentRow()

---

## ПАТТЕРНЫ И BEST PRACTICES

### 1. Связывание объектов при создании

✅ **Правильно:**
```javascript
// В DataForm.renderItem при создании таблицы
const table = new DynamicTable(config);
this.table = table;              // Прямая связь
table.onRowActivate = (idx) => { // Callback для событий
    this._currentRecord = table.dataCache[idx];
};
```

❌ **Неправильно:**
```javascript
// После создания искать таблицу
setTimeout(() => {
    const table = findTableInGlobalRegistry();
});
```

### 2. Использование callbacks для событий

✅ **Правильно:**
```javascript
table.onRowActivate = function(rowIndex) {
    // handle event
};
```

❌ **Неправильно:**
```javascript
table._originalActivateRow = table.activateRow;
table.activateRow = function(rowIndex) {
    table._originalActivateRow.call(this, rowIndex);
    // handle event
};
```

### 3. Cleanup при destroy

**Правило:** Если объект создается и умирает вместе (table + form), cleanup не нужен.

✅ **Не нужен cleanup:**
```javascript
destroy() {
    appForm.destroy();  // Таблица умрет вместе с формой
}
```

❌ **Нужен cleanup:**
```javascript
// Если мы повесили обработчик на ЧУЖОЙ объект
document.addEventListener('click', handler);
destroy() {
    document.removeEventListener('click', handler);
}
```

### 4. Получение данных из таблицы

**Локальный vs глобальный индекс:**
```javascript
// table._activeRowIndex - это локальный индекс (0-N)
// Для получения записи нужен глобальный:
const first = table.firstVisibleRow || 0;
const globalIndex = first + table._activeRowIndex;
const record = table.dataCache[globalIndex];
```

---

## ТИПИЧНЫЕ ОШИБКИ

### ❌ Использование глобальных реестров
```javascript
// ПЛОХО: может найти чужую таблицу
for (const tables of window._dynamicTableSubscribers.values()) {
    for (const t of tables) {
        if (t.tableName === 'my_table') return t;
    }
}
```

### ❌ setTimeout для синхронизации
```javascript
// ПЛОХО: race condition
setTimeout(() => {
    const table = findTable();
}, 100);
```

### ❌ Доступ по индексам
```javascript
// ПЛОХО: layout может измениться
const table = appForm.controlsMap[appForm.layout[0].name];
```

### ❌ Перехват методов
```javascript
// ПЛОХО: хрупко, сложно отладить
obj.method = function() {
    original();
    extraLogic();
};
```

### ❌ Установка layout стилей через JS
```javascript
// ПЛОХО: дублирование логики из CSS
element.style.flex = '1';
element.style.display = 'flex';

// ПРАВИЛЬНО: используй CSS классы
element.classList.add('flex-grow');
```

---

## КАК ДЕБАЖИТЬ

### 1. Проверь связи
```javascript
console.log('form.table:', appForm.table);
console.log('form._currentRecord:', appForm._currentRecord);
```

### 2. Проверь callback
```javascript
console.log('table.onRowActivate:', typeof table.onRowActivate);
```

### 3. Проверь индексы
```javascript
console.log('local index:', table._activeRowIndex);
console.log('first visible:', table.firstVisibleRow);
console.log('global index:', first + local);
console.log('record:', table.dataCache[global]);
```

### 4. Проверь контекст (this)
```javascript
callback.call(this);  // this должен быть правильным объектом
```
