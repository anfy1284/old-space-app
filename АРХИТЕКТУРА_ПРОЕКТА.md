# АРХИТЕКТУРА ПРОЕКТА MY-OLD-SPACE

Этот документ описывает техническую структуру и ключевые классы проекта.

---

## 1. ОБЩАЯ СТРУКТУРА

```
my-old-space/
├── drive_forms/
│   ├── dataApp.js                 # Dataset storage (storeDataset/getDataset)
│   ├── dbGateway.js               # Middleware уровня forms для dbGateway
│   ├── memory_store.js            # In-memory Map + опционально Redis
│   └── resources/public/
│       ├── UI_classes.js          # Базовые UI компоненты
│       ├── client.js              # callServerMethod(), App helper
│       └── style.css              # Глобальные стили (ВАЖНО!)
├── drive_root/
│   ├── dbGateway.js               # Ядро: единая точка доступа к БД + executor
│   ├── globalServerContext.js     # Модели, метаданные, динамические таблицы
│   └── ...
├── apps/
│   ├── organizations/             # Приложение для управления организациями
│   ├── uniListForm/               # Универсальная форма выбора записей (список)
│   ├── uniRecordForm/             # Универсальная форма редактирования записи
│   │   ├── server.js              # generateFormSpec, applyChanges, getLayoutWithData
│   │   └── resources/public/
│   │       └── client.js          # Создание DataForm, маршрутизация действий
│   └── ...
```

---

## 2. БАЗОВЫЕ КЛАССЫ (UI_classes.js)

### UIObject
Базовый класс всех визуальных компонентов. Свойства: `x, y, width, height, z, element`.

### Form (extends UIObject)
Окно с заголовком, кнопками управления (свернуть, развернуть, закрыть), drag/resize.
- `close()` → вызывает `this.destroy()`, удаляет DOM, диспатчит `form-destroyed`
- `destroy()` → уничтожает дочерние контролы
- `doAction(action, params)` → делегирует в `instance.onAction()` если есть

### DataForm (extends Form)
Базовый класс для форм с автоматическим рендерингом из JSON layout.

**Свойства:**
| Свойство | Назначение |
|---|---|
| `controlsMap` | Map всех созданных контролов `{name: control}` |
| `_dataMap` | Данные формы `{fieldName: {name, value, ...}}` |
| `_datasetId` | ID серверного датасета (хранит таблицу + ID записи) |
| `_modified` | Флаг изменения данных. При `true` — заголовок с ` *` |
| `_originalTitle` | Заголовок формы без суффикса ` *` |
| `_closing` | Защита от рекурсивного закрытия (guard) |
| `_currentRecord` | Текущая выбранная запись (setter обновляет контролы) |
| `table` | Ссылка на первую `DynamicTable` (устанавливается автоматически в `renderItem`) |

**Ключевые методы:**
| Метод | Назначение |
|---|---|
| `setModified(bool)` | Устанавливает `_modified`, добавляет/убирает ` *` из заголовка |
| `setTitle(title)` | Переопределён: сохраняет `_originalTitle`, учитывает `_modified` |
| `close()` | Переопределён: если `_modified`, спрашивает "Сохранить?" через `showConfirm` |
| `doAction('save')` | Вызывает `collectData()` → `applyChanges()` → сбрасывает `_modified` |
| `doAction('cancel')` | Вызывает `this.close()` (с диалогом сохранения если `_modified`) |
| `collectData()` | Обходит `controlsMap`, собирает `{field: value}` |
| `applyChanges(data)` | Отправляет `{datasetId, changes}` на сервер |
| `renderItem(item)` | Рендерит контрол по JSON-описанию, подключает dirty-tracking |

**Жизненный цикл:**
1. `MySpace.open('uniRecordForm', { tableName, recordID })` → создаёт экземпляр DataForm
2. `DataForm.Draw()` → `loadLayout()` → `getLayoutWithData()` → рендерит контролы
3. Пользователь редактирует → контролы вызывают `setModified(true)` → заголовок получает ` *`
4. При закрытии (X/ESC/Отмена): если `_modified` → `showConfirm("Сохранить?")` → "Да"=save+close, "Нет"=close
5. `Form.close()` → диспатчит `form-destroyed` → слушатель в DynamicTable вызывает `refresh()`

**Dirty Tracking (отслеживание изменений):**
Все контролы формы при изменении вызывают `formSelf.setModified(true)` (где `formSelf` — замыкание на DataForm):
| Контрол | Событие |
|---|---|
| TextBox, MultilineTextBox | `input` на `ctrl.element` |
| emunList (ComboBox listMode) | `input` на `ctrl.element` |
| recordSelector (TextBox + кнопка "...") | `input` на `ctrl.element` |
| CheckBox | `change` на `cb.element` |

### DynamicTable (extends Table)
Таблица с подгрузкой данных, SSE и кэшированием.
- `dataCache`: Кэш загруженных строк `{globalIndex: record}`.
- `firstVisibleRow`: Индекс первой видимой строки.
- `_activeRowIndex`: ЛОКАЛЬНЫЙ индекс активной строки (0-N внутри вьюпорта).
- `onRowActivate(globalIndex)`: Callback, вызываемый при активации строки.
- `onSelectOrOpen(rowIndex)`: Двойной клик → открывает uniRecordForm, подписывается на `form-destroyed` для обновления.
- `refresh()`: Перезагружает данные с сервера и перерисовывает таблицу.

**Важно:** Глобальный индекс записи = `firstVisibleRow + _activeRowIndex`.

### Стандартные контролы
| Класс | Назначение | getValue() |
|---|---|---|
| `TextBox` | Текстовое поле | Для `showSelectionButton` → `rawValue` (FK ID); иначе → `getText()` |
| `MultilineTextBox` | Многострочное поле | `getText()` |
| `CheckBox` | Флажок | `getChecked()` → `boolean` |
| `ComboBox` | Выпадающий список | `getText()` |
| `DatePicker` | Выбор даты | `getValue()` → `Date` |
| `Button` | Кнопка | N/A |
| `Group` | Группировка контролов | N/A |

### Стандартные диалоги
| Функция | Кнопки | API |
|---|---|---|
| `showAlert(msg, onOk)` | OK | Callback |
| `showConfirm(msg, onOk, onCancel)` | Да / Нет | Callback или `await` → `true`/`false` |

---

## 3. КОММУНИКАЦИЯ КЛИЕНТ-СЕРВЕР

### RPC
```
callServerMethod(appName, methodName, params)
  → POST /app/call { app, method, params }
  → invokeAppMethod(app, method, params, sessionID, cb, req, res)
  → appModule[methodName](params, sessionID, req, res)
```
Первый аргумент серверного метода — **один объект** `params`.

### Dataset (контекст между вызовами)
```javascript
// Сохранение:
const id = dataApp.storeDataset({ table: 'organizations', id: 42, ... });
// Получение:
const ds = dataApp.getDataset(id); // → { table, id, ... }
```

### uniRecordForm: серверные методы
| Метод | Параметры | Назначение |
|---|---|---|
| `getLayoutWithData` | `{ tableName, recordID }` | Генерирует layout + данные + datasetId |
| `generateFormSpec` | `(tableName, params)` | Строит layout из метаданных модели |
| `applyChanges` | `{ datasetId, changes }` | Извлекает таблицу/ID из dataset, вызывает `Model.update()` |

---

## 4. СИСТЕМА ПРИЛОЖЕНИЙ (MySpace)

### `window.MySpace`
| Метод | Назначение |
|---|---|
| `register(name, descriptor)` | Регистрация приложения |
| `open(name, params)` → `Promise<id>` | Открытие (для `allowMultipleInstances` — новый экземпляр) |
| `getInstance(id)` | Получение экземпляра по ID |
| `close(id)` | Вызывает `inst.destroy()`, удаляет из реестра |

### Экземпляр приложения (instance)
```javascript
{
    id: string,
    appName: string,
    form: DataForm,        // ссылка на форму
    onOpen(params): void,  // вызывается при открытии
    onAction(action, params): void,  // делегирует в appForm.doAction()
    destroy(): void        // очистка
}
```

### Два потока закрытия
| Действие | Что вызывается | Результат |
|---|---|---|
| Кнопка X / ESC | `Form.close()` → `destroy()` + удаление DOM + событие `form-destroyed` | Экземпляр остаётся в MySpace registry |
| `MySpace.close(id)` | `inst.destroy()` + удаление из registry | DOM не удаляется автоматически |

**Вывод:** Для реакции на закрытие формы пользователем — слушай событие `form-destroyed`, а не оборачивай `inst.destroy`.

---

## 5. СТИЛИ И LAYOUT (style.css, WIN95 STYLE)

Система использует Flexbox для управления пространством (см. [style.css](node_modules/my-old-space/drive_forms/resources/public/style.css)).
- `.ui-form-content`: Flex-контейнер (column) для элементов формы.
- `.ui-dynamictable`: Имеет `flex: 1 1 auto`, чтобы занимать свободное место.
- `.ui-group`: Группировка элементов (`horizontal` или `vertical`).

---

## 6. dbGateway — ЕДИНАЯ ТОЧКА ДОСТУПА К БД

### Назначение
Все операции чтения/записи бизнес-данных проходят через `dbGateway.execute()`. Это позволяет перехватывать, проверять, модифицировать или блокировать запросы на любом уровне.

### Архитектура (каскадные middleware)
```
ЗАПРОС → [APP middleware] → [FORMS middleware] → [ROOT middleware] → EXECUTOR (Sequelize) → РЕЗУЛЬТАТ
```

Три уровня middleware:
| Уровень | Файл | Назначение |
|---|---|---|
| `app` | Регистрируется в `server.js` приложения | Бизнес-логика конкретного приложения |
| `forms` | `drive_forms/dbGateway.js` | Проверки сессий, прав, общие для форм |
| `root` | `drive_root/dbGateway.js` | Системные проверки, аудит, rate-limiting |

### API

**`dbGateway.execute(request)`** — выполнить запрос к БД через цепочку middleware.

```javascript
const result = await dbGateway.execute({
    operation: 'read',              // 'read'|'findByPk'|'findOne'|'count'|'create'|'update'|'delete'
    table: 'organizations',         // имя таблицы (как в БД)
    where: { id: 5 },              // условия (опционально)
    data: { name: 'Test' },        // данные для create/update (опционально)
    options: {                      // опции Sequelize (опционально)
        order: [['name', 'ASC']],
        limit: 20,
        offset: 0,
        raw: true,
        transaction: t             // для транзакций
    },
    context: {                      // контекст вызова (опционально)
        sessionID: 'abc',
        userId: 42,
        appName: 'uniListForm'
    }
});
```

**`dbGateway.use(level, fn)`** — регистрация middleware.

```javascript
// Сигнатура middleware:
async function myMiddleware(request, next) {
    // Изменить request...
    const result = await next(request);  // передать дальше
    // Изменить result...
    return result;
}

dbGateway.use('app', myMiddleware);
```

### Executor (конечная точка)
Расположен в `drive_root/dbGateway.js`. Преобразует `request` в вызов Sequelize:
| operation | Sequelize метод |
|---|---|
| `read` | `Model.findAll()` |
| `findByPk` | `Model.findByPk()` |
| `findOne` | `Model.findOne()` |
| `count` | `Model.count()` |
| `create` | `Model.create()` |
| `update` | `Model.update()` |
| `delete` | `Model.destroy()` |

### Инициализация
- `drive_root/init.js` → `require('./dbGateway')` (загружает ядро)
- `drive_forms/init.js` → `require('./dbGateway')` (регистрирует forms-middleware)
- Приложения регистрируют app-middleware в своём `server.js` или `init.js` по необходимости

### Что НЕ проходит через dbGateway
Системные операции (сессии, авторизация, миграции) пока используют прямые вызовы Sequelize: `getUserBySessionID`, `createNewUser`, `createGuestUser`, `loadDefaultValuesFromDB`.

---

## 7. ПРАВИЛА РАБОТЫ
Процесс разработки, принципы кодирования, анти-паттерны и чеклист самопроверки описаны в [ИНСТРУКЦИИ_ДЛЯ_AI.md](ИНСТРУКЦИИ_ДЛЯ_AI.md).
