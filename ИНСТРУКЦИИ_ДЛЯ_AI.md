# ИНСТРУКЦИИ ДЛЯ AI АССИСТЕНТА (v2.0)

Этот документ является определяющим для стиля, архитектуры и процесса разработки в проекте.

---

## 1. РЕЖИМ РАБОТЫ И КОММУНИКАЦИЯ

### Начало и завершение задачи
- **СТАРТ:** При получении команды "сначала прочти инструкции" — автоматически и полностью перечитывай этот файл и [АРХИТЕКТУРА_ПРОЕКТА.md](АРХИТЕКТУРА_ПРОЕКТА.md). Не спрашивай разрешения на чтение.
- **В ПРОЦЕССЕ:** Перед любыми правками кода отправь 1-2 коротких предложения: что собираешься сделать и в каком файле.
- **СТОП:** Если решение может нарушить архитектуру или ты сомневаешься — остановись и уточни у пользователя.
- **ФИНАЛ:** По команде "дополни инструкции" — проанализируй чат, найди ошибки и обнови этот документ. 
- **РЕФАКТОРИНГ:** При каждом добавлении новых инструкций — проводи полный рефакторинг этого файла, чтобы он оставался структурированным, чистым и без дублирования.

### Технические правила (CRITICAL)
- **Правка файлов:** КАТЕГОРИЧЕСКИ ЗАПРЕЩЕНО использовать команды терминала (`run_in_terminal`, `sed`, `echo >` и т.д.) для создания или редактирования файлов. Используй только специализированные инструменты (`replace_string_in_file`, `create_file`). Это необходимо для прозрачности изменений и возможности их отката.
- **node_modules:** Допускается точечная правка системных библиотек (например, `my-old-space`), если проблема в базовом классе.

### Правила взаимодействия
- **Слушай фидбек:** Если пользователь говорит "это не то" или "это костыль" — не защищай решение. Признай ошибку и смени стратегию.
- **Минимализм:** Делай точечные изменения. Не рефактори лишнее, если не просили. Используй существующие параметры (например, `openParams`, `appForm`, `instance`).

---

## 2. АРХИТЕКТУРНЫЕ ПРИНЦИПЫ (CORE DESIGN)

### Системность и иерархия
- **Базовые классы:** Приоритет правки в `UI_classes.js` (классы `Form`, `UIObject`, `Table`, `DataForm`). Решение в базе исправляет баг во всех приложениях сразу.
- **Связь DOM и Объектов:** Всегда пробрасывай ссылку на объект в DOM-элемент: `element._uiObject = this;`. Это позволяет системным методам (как `updateAllRowsReadOnly`) корректно управлять состоянием контрола.
- **Idempotent Rendering:** Метод `Draw` и загрузка данных должны учитывать текущее состояние (например, восстанавливать знаки сортировки ▲/▼ и ширины колонок при перерисовке).
- **Минимальное логирование:** Удали `console.log` после исправления задачи. Оставляй только критические ошибки.

### Работа с событиями (Event Flow)
- **Флаги состояний:** Для разделения сложных взаимодействий (drag vs click) используй внутренние флаги (например, `this._resizeOccurred`). Сбрасывай их в `mousedown` и проверяй в `click`.
- **Координация кликов:** Для предотвращения двойного срабатывания в сложных компонентах (например, CheckBox внутри ячейки таблицы) используй свойство события `ev.__checkboxHandled = true`.

---

## 3. UI, CSS И ВИЗУАЛЬНЫЙ СТИЛЬ (WIN95 STYLE)

### Стили и Layout
- **CSS-First:** Всегда проверяй [style.css](node_modules/my-old-space/drive_forms/resources/public/style.css) перед изменением JS.
- **Retro Scrollbars:** Используй кастомные стили `::-webkit-scrollbar` с 3D-эффектами (bevel) и SVG стрелочками для кнопок. Трек (track) должен иметь dither-текстуру (через PNG 2x2 Data URI).
- **Никаких inline-стилей:** Не меняй `element.style` напрямую для статичных свойств. Используй классы.
- **Lifecycle:** Всегда удаляй `ResizeObserver` и `EventListener` в методе `destroy()`.
- **Layout:** Используй `table-layout: fixed` для таблиц с управляемой шириной колонок.

---

## 4. ЧЕГО ДЕЛАТЬ НЕЛЬЗЯ (ANTI-PATTERNS)

- ❌ **Таймауты:** КАТЕГОРИЧЕСКИ ЗАПРЕЩЕНО использовать `setTimeout` для ожидания отрисовки или инициализации. Используй флаги состояний и логику событий.
- ❌ **Разрушающее обновление:** Не используй `element.textContent = ...` или `innerHTML` для узлов, содержащих интерактивные под-элементы (например, resize-ручки). Создавай `span` для текста.
- ❌ **Глобальные реестры:** Использование `window.something` для связи между локальными объектами.
- ❌ **Поиск по признакам:** Не используй индексы (`layout[0]`) или `firstElementChild`, если можно использовать именованные ссылки или Map.

---

## 5. ЧЕКЛИСТ САМОПРОВЕРКИ

1. **Базовый класс:** Я поискал решение в `UI_classes.js` прежде чем писать код в приложении?
2. **Стейт:** Сохранится ли ширина колонок и знаки сортировки после обновления данных с сервера?
3. **События:** Не срабатывает ли лишний `click` после завершения `drag`? Использовал ли я флаг вместо `setTimeout`?
4. **Стиль:** Все новые стили вынесены в CSS?
5. **Очистка:** Есть ли очистка (cleanup) в `destroy()`?
6. **Инструментарий:** Использовал ли я правильный инструмент для правки файла (не терминал)?
